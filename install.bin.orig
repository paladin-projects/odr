#!/bin/bash
#
# Installation script for Onsite Data Recorder  service
# by mcwees at hpe dot com
#
# v 0.9
# - Add http config for odr web interface
#
# v 0.8
# - Add code to only unique strings to the crontab
#
# v 0.7
# - Add free space calc at mountpoint
# - Add cronjob for calc
#
# v 0.6 changes
# - Add html config for odr host alias
#
# v 0.5 changes:
# 
# - Add silent ssh key generation
# - Add cronjob for remove old archives
#

export PATH=$PATH:/usr/sbin:/sbin
# Check prereq
PREREQ=(tar bzip2 find ssh ssh-keygen crontab awk apachectl bc logger sort uniq)
L1="            "
L2="                   "
for i in ${PREREQ[*]}
do
	P=`which $i 2>/dev/null`
	if [[ $P == *"bin"* ]]
	then
		S="Found"
	else
		S="Not found"
	fi
	printf "%s %s %s %s %s" $i "${L1:${#i}}" $P "${L2:${#P}}" $S
	echo
	if [[ $S == "Not found" ]]
	then
		echo "Command $i not found"
		exit 0
	fi
done

# Unpack archive
ARCHIVE=`awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' $0`
tail -n+$ARCHIVE $0 | tar xjv

# Generate ssh key
KEY=~/.ssh/id_rsa
ssh-keygen -q -t rsa -N '' -f $KEY <<<y 2>&1 >/dev/null
echo "
New RSA public key (you always can see it in ${KEY}.pub):
--- install this key to target array(s) ----"
cat ${KEY}.pub
echo "------- end -------"

# Generate config file
CLI=`which ssh`
if [ -f "./bin/odr.conf" ]
then
	echo "Config file exists"
else
	echo "Create new config file"
echo "#
# Onsite Data Recorder config file
#

ITER=960        # Iterations
DELAY=15        # Delay between iterations,
		# ITER * DELAY is always must be 4 hours!
REMOVE=31       # Remove files above 31 days old
CLI=$CLI
HOME=$HOME
DATA=$HOME/data
DATAPOINT=
" >./bin/odr.conf
fi

# Calc free storage space script
echo "#!/bin/bash

. $HOME/bin/odr.conf

df -h | awk -v data=\$DATAPOINT '
\$6 == data {
  print \"<p><pre>\"
  print \"Mount point \" \$6 \" free space: \" \$4
  print \"Used: \" \$5
  print \"</pre></p>\"
}' > \$DATA/.storstat
" >./bin/storecalc.sh

chmod +x ./bin/storecalc.sh


# Chown for me
ME=`whoami`
chown -R $ME .

# Add job to remove old arcs to crontab
B=`getent passwd $ME | cut -d: -f6`
BIN=${B}/bin
CRON1="10 22 * * * ${BIN}/removeday.sh"
CRON2="*/15 * * * * ${BIN}/storecalc.sh"
crontab -l 2>&1 > /dev/null
if [ $? -ne 0 ]
then
  ( echo "$CRON1"; echo "$CRON2" ) | crontab -
else
  crontab -l | grep -vE "^#" | ( cat; echo "$CRON1"; echo "$CRON2" ) |\
	 sort | uniq |  crontab -
fi

# http aliases for odr generate
sed -i -e "s/..HOME../$HOME/" odr-http.conf

#
##### Finalization
#
echo
echo "All done.
Now you should install ssh key to target arrays and configure crontab"
echo
exit 0
__ARCHIVE_BELOW__
